# Ant
# Build your Java projects and run tests with Apache Ant.
# Add steps that save build artifacts and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/java

trigger:
- master
  
pool:
  name: Default

steps:
- script: |
    echo add_class_folder;
    mkdir ./build/WEB-INF/classes
  displayName: 'Add class folder'

- task: Ant@1
  inputs:
    buildFile: 'build.xml'
    options: 
    targets: 'build'
    publishJUnitResults: true
    testResultsFiles: '**/TEST-*.xml'
    javaHomeOption: 'JDKVersion'
  displayName: 'Ant Build'
- script: |
    wget https://web.archive.org/web/20220814053943if_/https://discotek.ca/download?file=discotek.deepdive-1.5.11-beta.zip -O deepdive1.zip
    unzip deepdive1.zip
    mkdir deepdive_result
    java -Xmx4G -jar deepdive-1.5.11-beta/lib/discotek.deepdive-engine-1.5.11-beta.jar -decompile=true -project-directory=deepdive-1.5.11-beta/sample-config -output-directory=deepdive_result  ./build/bodgeit.war
  displayName: 'SAST - Deepdive'
  continueOnError: Yes
- script: |
      set -e
      git config --global user.email "azuredevops@microsoft.com"
      git config --global user.name "Azure DevOps" 
      git checkout -b $(Build.SourceBranchName)
      sudo CODE_DIR=$(Build.SourcesDirectory) checkmate init
      sudo CODE_DIR=$(Build.SourcesDirectory) checkmate git init
      sudo CODE_DIR=$(Build.SourcesDirectory) checkmate git analyze --branch $(Build.SourceBranchName)
      sudo CODE_DIR=$(Build.SourcesDirectory) checkmate issues html
      displayName: Static Application Security Test (SAST)
      env:
        CODE_DIR: '$(Build.SourcesDirectory)'
- task: dependency-check-build-task@6
  inputs:
    projectName: 'Deloitte-DevSecOps.bodgeit'
    scanPath: './**/*.jar'
    format: 'CSV'
    additionalArguments: '--dotnet /home/kali/.dotnet/dotnet --disableRetireJS'
- task: TomcatDeployment@1
  inputs:
    TomcatUrl: 'http://localhost:8080'
    Username: 'admintomsec'
    Password: 'hem03!'
    Warfile: './build/bodgeit.war'
    Context: '/'
    ServerVersion: '7OrAbove'
- script: |
    /usr/share/zaproxy/zap.sh -cmd -quickurl http://localhost:8080/bodgeit -quickout /home/kali/report.html
  displayName: 'DAST - OWASP ZAP'

#failOnCVSS: '7'
#-  script: |
#   export CODE_DIR=${PWD}
#   cd $CODE_DIR
#   sh /home/kali/Desktop/betterscan-ce/betterscan-ce/cli-html.sh
#   displayName: 'Betterscan - SAST'
